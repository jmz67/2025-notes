
当我们渲染进入 signin 页面的时候，我们会先从去 URL 中将参数提取出来，然后使用 decodeURIComponent 将参数中附带的这些 token 提取出来。

```jsx
import useSearchParams from "next/navigation"

const searchParams = useSearchParams();

// 从 URL 查询参数中获取相关值，并进行解码
const consoleToken = decodeURIComponent(searchParams.get('access_token') || '')
const refreshToken = decodeURIComponent(searchParams.get('refresh_token') || '')
const message = decodeURIComponent(searchParams.get('message') || '')
const invite_token = decodeURIComponent(searchParams.get('invite_token') || '')

```

在提取到这些 token 之后，我们会去验证是否同时包含两个必要的 token ，如果都有我们就会将他们存入 cookie 中，然后跳转进入 apps 页面。这种情况我感觉一般用于用户已经登录了，然后将失误操作回到了登录界面。我们的登录界面这个时候会重新获取一遍用户的 token 状态然后再保存起来。

然后就是一系列的验证系统设置里面设置的登录操作是什么，这里我们只将默认的邮件和密码登录表单组件。在这个组件中，我们终于看到了在浏览器上看到的还未登录的时候就有的一个 token locale 

![[Pasted image 20250219232606.png]]

```jsx
import {useContext} from 'use-context-selector'

const { locale } = useContext(I18NContext)
```

但是很遗憾，我好像没有看到哪里有 localStorage 去将它保存在 cookie 中，在这里它的作用只是将它打包在 data 里面一并发给 login 路由请求后端。

```jsx
const loginData: Record<string, any> = {
    email,
    password,
    language: locale,
    remeber_me: true,
}

if (isInvite)
    loginData.invite_token = decodeURIComponent(searchParams.get('invite_token') as string)

const res = await login({
    url: '/login',
    body: loginData,
})
```

我们来看看后端的代码是怎么处理这些输入数据的：

```python
class LoginApi(Resource):
	"""Resource for user login."""

	@setup_required
	def post(self):
		"""Authenticate user and login."""

		# 创建请求解析器，用于解析请求中的参数
		parser = RequestParser()

		# 添加请求参数及其验证规则
		parser.add_argument("email", type=email, required=True, location="json") 
		# 验证邮箱格式

		parser.add_argument("password", type=valid_password, required=True, location="json")
		# 验证密码格式

		parser.add_argument("remember_me", type=bool, required=False, default=False, location="json")  
		# 是否记住登录
        
        parser.add_argument("invite_token", type=str, required=False, default=None, location="json")  
        # 邀请令牌
        
        parser.add_argument("language", type=str, required=False, default="en-US", location="json")  
        # 用户语言

        args = parser.parser_args()
        # 解析请求参数

        # 如果计费功能启用且用户邮箱被冻结，抛出异常
        if dify_config.BILLING_ENABLED and BillingService.is_email_in_freeze(args["email"]):
        	raise AccountInFreezeError()

        # 检查是否达到登录错误限制
        is_login_error_rate_limit = AccountService.is_login_error_rate_limit(args["email"])
        if is_login_error_rate_limit:
            raise EmailPasswordLoginLimitError()

        # 获取邀请令牌
        invitation = args["invite_token"]
        if invitation:
        	# 验证邀请令牌是否有效
        	invitation = RegisterService.get_invitation_if_token_valid(None, args[email], inviation)

       	if args["language"] is not None and args["langugae"] == "zh-Hans":
       		language = "zh-Hans"
       	else:
       		language = "en-US"

       	# 尝试验证用户身份
       	try:
       		if invitation:
       			# 如果有邀请令牌，验证邀请信息
       			data = invitation.get("data", {})
       			invitee_email = data.get("email") if data else None
       			if invitee_email != args["email"]:
       				raise InvalidEmailError()

       			# 使用邀请令牌进行身份验证
       			account = AccountService.authenticate(args["email"], args["password"])

       		else:
       			# 没有邀请令牌，正常验证用户
       			account = AccountService.authenticate(args["email"], args["password"])

       	except services.errors.account.AccountLoginError:
       		# 如果账户被禁用，抛出异常
            raise AccountBannedError()
        except services.errors.account.AccountPasswordError:
            # 如果密码错误，记录错误次数并抛出异常
            AccountService.add_login_error_rate_limit(args["email"])
            raise EmailOrPasswordMismatchError()
  		except services.errors.account.AccountNotFoundError:
            # 如果账户未找到
            if FeatureService.get_system_features().is_allow_register:
                # 如果允许注册，发送重置密码邮件
                token = AccountService.send_reset_password_email(email=args["email"], language=language)
                return {"result": "fail", "data": token, "code": "account_not_found"}
            else:
                # 如果不允许注册，抛出异常
                raise AccountNotFound()      

        # 获取用户所属的租户信息
        tenants = TenantService.get_join_tenants(account)
        if len(tenants) == 0:
            # 如果没有租户信息，返回失败提示
            return {
                "result": "fail",
                "data": "workspace not found, please contact system admin to invite you to join in a workspace",
            }

        # 用户登录成功，生成登录令牌
        token_pair = AccountService.login(account=account, ip_address=extract_remote_ip(request))
        # 重置登录错误次数
        AccountService.reset_login_error_rate_limit(args["email"])
        # 返回登录成功的结果
        return {"result": "success", "data": token_pair.model_dump()}
```




```jsx
import React, { useCallback, useEffect, useState } from 'react'  // 引入 React 和相关 hooks
import { useTranslation } from 'react-i18next'  // 用于多语言翻译
import Link from 'next/link'  // 用于 Next.js 的链接组件
import { useRouter, useSearchParams } from 'next/navigation'  // Next.js 路由相关功能
import { RiContractLine, RiDoorLockLine, RiErrorWarningFill } from '@remixicon/react'  // 引入图标组件
import Loading from '../components/base/loading'  // 引入 Loading 组件
import MailAndCodeAuth from './components/mail-and-code-auth'  // 引入邮箱验证码登录组件
import MailAndPasswordAuth from './components/mail-and-password-auth'  // 引入邮箱密码登录组件
import SocialAuth from './components/social-auth'  // 引入社交账号登录组件
import SSOAuth from './components/sso-auth'  // 引入单点登录（SSO）组件
import cn from '@/utils/classnames'  // 引入动态类名工具
import { getSystemFeatures, invitationCheck } from '@/service/common'  // 引入获取系统功能和邀请验证的服务
import { LicenseStatus, defaultSystemFeatures } from '@/types/feature'  // 引入许可证状态和默认系统功能
import Toast from '@/app/components/base/toast'  // 引入 Toast 消息组件
import { IS_CE_EDITION } from '@/config'  // 引入是否为企业版的配置

const NormalForm = () => {  // 登录表单组件

  const { t } = useTranslation()  // 获取翻译功能
  const router = useRouter()  // 获取路由实例
  const searchParams = useSearchParams()  // 获取 URL 中的查询参数

  // 从 URL 查询参数中获取相关值，并进行解码
  const consoleToken = decodeURIComponent(searchParams.get('access_token') || '')
  const refreshToken = decodeURIComponent(searchParams.get('refresh_token') || '')
  const message = decodeURIComponent(searchParams.get('message') || '')
  const invite_token = decodeURIComponent(searchParams.get('invite_token') || '')

  // 定义一些 UI 状态
  const [isLoading, setIsLoading] = useState(true)  // 控制加载状态
  const [systemFeatures, setSystemFeatures] = useState(defaultSystemFeatures)  // 存储系统功能配置
  const [authType, updateAuthType] = useState<'code' | 'password'>('password')  // 控制当前的认证方式
  const [showORLine, setShowORLine] = useState(false)  // 控制是否显示 OR 分隔线
  const [allMethodsAreDisabled, setAllMethodsAreDisabled] = useState(false)  // 控制是否禁用所有认证方法
  const [workspaceName, setWorkSpaceName] = useState('')  // 存储工作区名称

  // 判断是否为邀请链接
  const isInviteLink = Boolean(invite_token && invite_token !== 'null')

  // 初始化函数
  const init = useCallback(async () => {  // 使用 useCallback 确保函数不在每次渲染时都重新定义
    try {
      // 如果 URL 中包含 access_token 和 refresh_token，则直接存储并跳转
      if (consoleToken && refreshToken) {
        localStorage.setItem('console_token', consoleToken)  // 保存 console_token 到 localStorage
        localStorage.setItem('refresh_token', refreshToken)  // 保存 refresh_token 到 localStorage
        router.replace('/apps')  // 重定向到 /apps 页面
        return
      }

      // 如果 URL 中包含 message，显示错误提示
      if (message) {
        Toast.notify({
          type: 'error',
          message,
        })
      }

      // 获取系统功能配置
      const features = await getSystemFeatures()
      const allFeatures = { ...defaultSystemFeatures, ...features }  // 合并默认功能和获取到的功能
      setSystemFeatures(allFeatures)  // 更新系统功能状态
      // 判断是否禁用所有认证方法
      setAllMethodsAreDisabled(!allFeatures.enable_social_oauth_login && !allFeatures.enable_email_code_login && !allFeatures.enable_email_password_login && !allFeatures.sso_enforced_for_signin)
      // 判断是否显示 OR 分隔线
      setShowORLine((allFeatures.enable_social_oauth_login || allFeatures.sso_enforced_for_signin) && (allFeatures.enable_email_code_login || allFeatures.enable_email_password_login))
      // 根据是否允许邮箱密码登录来设置默认认证方式
      updateAuthType(allFeatures.enable_email_password_login ? 'password' : 'code')

      // 如果是邀请链接，验证邀请
      if (isInviteLink) {
        const checkRes = await invitationCheck({
          url: '/activate/check',
          params: {
            token: invite_token,
          },
        })
        setWorkSpaceName(checkRes?.data?.workspace_name || '')  // 获取并设置工作区名称
      }
    }
    catch (error) {
      console.error(error)  // 打印错误日志
      setAllMethodsAreDisabled(true)  // 如果发生错误，禁用所有认证方法
      setSystemFeatures(defaultSystemFeatures)  // 重置系统功能为默认值
    }
    finally { 
      setIsLoading(false)  // 无论成功还是失败，加载完成
    }
  }, [consoleToken, refreshToken, message, router, invite_token, isInviteLink])  // 依赖项：consoleToken、refreshToken 等

  useEffect(() => {  // 组件加载时调用初始化函数
    init()
  }, [init])  // 依赖项：init

  // 如果正在加载或者已经有有效的 consoleToken，显示 loading 状态
  if (isLoading || consoleToken) {
    return <div className={cn('flex flex-col items-center w-full grow justify-center', 'px-6', 'md:px-[108px]')}>
      <Loading type='area' />  {/* 加载动画 */}
    </div>
  }

  // 如果许可证状态为 LOST，显示相应提示
  if (systemFeatures.license?.status === LicenseStatus.LOST) {
    return <div className='w-full mx-auto mt-8'>
      <div className='bg-white'>
        <div className="p-4 rounded-lg bg-gradient-to-r from-workflow-workflow-progress-bg-1 to-workflow-workflow-progress-bg-2">
          <div className='flex items-center justify-center w-10 h-10 rounded-xl bg-components-card-bg shadow shadows-shadow-lg mb-2 relative'>
            <RiContractLine className='w-5 h-5' />  {/* 图标 */}
            <RiErrorWarningFill className='absolute w-4 h-4 text-text-warning-secondary -top-1 -right-1' />  {/* 错误提示图标 */}
          </div>
          <p className='system-sm-medium text-text-primary'>{t('login.licenseLost')}</p>
          <p className='system-xs-regular text-text-tertiary mt-1'>{t('login.licenseLostTip')}</p>
        </div>
      </div>
    </div>
  }

  // 如果许可证状态为 EXPIRED，显示相应提示
  if (systemFeatures.license?.status === LicenseStatus.EXPIRED) {
    return <div className='w-full mx-auto mt-8'>
      <div className='bg-white'>
        <div className="p-4 rounded-lg bg-gradient-to-r from-workflow-workflow-progress-bg-1 to-workflow-workflow-progress-bg-2">
          <div className='flex items-center justify-center w-10 h-10 rounded-xl bg-components-card-bg shadow shadows-shadow-lg mb-2 relative'>
            <RiContractLine className='w-5 h-5' />  {/* 图标 */}
            <RiErrorWarningFill className='absolute w-4 h-4 text-text-warning-secondary -top-1 -right-1' />  {/* 错误提示图标 */}
          </div>
          <p className='system-sm-medium text-text-primary'>{t('login.licenseExpired')}</p>
          <p className='system-xs-regular text-text-tertiary mt-1'>{t('login.licenseExpiredTip')}</p>
        </div>
      </div>
    </div>
  }

  // 如果许可证状态为 INACTIVE，显示相应提示
  if (systemFeatures.license?.status === LicenseStatus.INACTIVE) {
    return <div className='w-full mx-auto mt-8'>
      <div className='bg-white'>
        <div className="p-4 rounded-lg bg-gradient-to-r from-workflow-workflow-progress-bg-1 to-workflow-workflow-progress-bg-2">
          <div className='flex items-center justify-center w-10 h-10 rounded-xl bg-components-card-bg shadow shadows-shadow-lg mb-2 relative'>
            <RiContractLine className='w-5 h-5' />  {/* 图标 */}
            <RiErrorWarningFill className='absolute w-4 h-4 text-text-warning-secondary -top-1 -right-1' />  {/* 错误提示图标 */}
          </div>
          <p className='system-sm-medium text-text-primary'>{t('login.licenseInactive')}</p>
          <p className='system-xs-regular text-text-tertiary mt-1'>{t('login.licenseInactiveTip')}</p>
        </div>
      </div>
    </div>
  }

  return (  // 渲染登录表单
    <>
      <div className="w-full mx-auto mt-8">
        {isInviteLink  // 如果是邀请链接，显示工作区相关信息
          ? <div className="w-full mx-auto">
            <h2 className="title-4xl-semi-bold text-text-primary">{t('login.join')}{workspaceName}</h2>
            <p className='mt-2 body-md-regular text-text-tertiary'>{t('login.joinTipStart')}{workspaceName}{t('login.joinTipEnd')}</p>
          </div>
          : <div className="w-full mx-auto">
            <h2 className="title-4xl-semi-bold text-text-primary">{t('login.pageTitle')}</h2>
            <p className='mt-2 body-md-regular text-text-tertiary'>{t('login.welcome')}</p>
          </div>}
        <div className="bg-white">
          <div className="flex flex-col gap-3 mt-6">
            {systemFeatures.enable_social_oauth_login && <SocialAuth />}  {/* 显示社交登录组件 */}
            {systemFeatures.sso_enforced_for_signin && <div className='w-full'>
              <SSOAuth protocol={systemFeatures.sso_enforced_for_signin_protocol} />  {/* 显示 SSO 登录组件 */}
            </div>}
          </div>

          {showORLine && <div className="relative mt-6">
            <div className="absolute inset-0 flex items-center" aria-hidden="true">
              <div className='bg-gradient-to-r from-background-gradient-mask-transparent via-divider-regular to-background-gradient-mask-transparent h-px w-full'></div>
            </div>
            <div className="relative flex justify-center">
              <span className="px-2 text-text-tertiary system-xs-medium-uppercase bg-white">{t('login.or')}</span>
            </div>
          </div>}
          {
            (systemFeatures.enable_email_code_login || systemFeatures.enable_email_password_login) && <>
              {systemFeatures.enable_email_code_login && authType === 'code' && <>
                <MailAndCodeAuth isInvite={isInviteLink} />  {/* 显示邮箱验证码登录组件 */}
                {systemFeatures.enable_email_password_login && <div className='cursor-pointer py-1 text-center' onClick={() => { updateAuthType('password') }}>
                  <span className='system-xs-medium text-components-button-secondary-accent-text'>{t('login.usePassword')}</span>
                </div>}
              </>}
              {systemFeatures.enable_email_password_login && authType === 'password' && <>
                <MailAndPasswordAuth isInvite={isInviteLink} isEmailSetup={systemFeatures.is_email_setup} allowRegistration={systemFeatures.is_allow_register} />  {/* 显示邮箱密码登录组件 */}
                {systemFeatures.enable_email_code_login && <div className='cursor-pointer py-1 text-center' onClick={() => { updateAuthType('code') }}>
                  <span className='system-xs-medium text-components-button-secondary-accent-text'>{t('login.useVerificationCode')}</span>
                </div>}
              </>}
            </>
          }
          
          {/* 如果没有可用的登录方法，则显示提示 */}
        </div>
      </div>
    </>
  )
}

export default NormalForm  // 导出登录表单组件
```


```jsx
// 导入 Next.js 的 Link 组件，用于页面跳转
import Link from 'next/link';
// 导入 React 的 useState 钩子，用于管理组件状态
import { useState } from 'react';
// 导入 react-i18next 的 useTranslation 钩子，用于国际化翻译
import { useTranslation } from 'react-i18next';
// 导入 Next.js 的 useRouter 和 useSearchParams 钩子，用于路由操作和获取查询参数
import { useRouter, useSearchParams } from 'next/navigation';
// 导入 useContext 钩子，用于访问上下文
import { useContext } from 'use-context-selector';
// 导入 Button 组件，用于创建按钮
import Button from '@/app/components/base/button';
// 导入 Toast 组件，用于显示提示信息
import Toast from '@/app/components/base/toast';
// 导入 emailRegex，用于验证电子邮件格式
import { emailRegex } from '@/config';
// 导入 login 函数，用于执行登录操作
import { login } from '@/service/common';
// 导入 Input 组件，用于创建输入框
import Input from '@/app/components/base/input';
// 导入 I18NContext，用于访问国际化上下文
import I18NContext from '@/context/i18n';

// 定义密码正则表达式，用于验证密码格式
const passwordRegex = /^(?=.*[a-zA-Z])(?=.*\d).{8,}$/;

// 定义组件的属性类型
type MailAndPasswordAuthProps = {
    isInvite: boolean; // 是否邀请登录
    isEmailSetup: boolean； // 是否已设置电子邮件
    allowRegisteration: boolean; // 是否允许注册
}

// 定义组件，接收 isInvite, isEmailSetup 和 allowRegisteration 属性
export default function MailAndPasswordAuth({ isInvite, isEmailSetup, allowRegisteration }: MailAndPasswordAuthProps) {
    // 使用 useTranslation 钩子获取翻译函数
    const { t } = useTranslation();

    // 使用 useContext 钩子访问国际上下文，获取当前语言
    const { locale } = useContext(I18NContext);

    // 使用 useRouter 钩子获取路由对象
    const router = useRouter();

    // 使用 useSearchParams 钩子获取查询参数
    const searchParams = useSearchParams();

    // 定义是否显示密码的状态，并提供更新函数
    const [showPassword, setShowPassword] = useState(false);

    // 从查询参数中获取电子邮件地址，并进行解码
    const emailFromLink = decodeURIComponent(searchParams.get('email') || '')

    // 定义电子邮件状态，并提供更新函数，初始值为从链接中获取的电子邮件
    const [email, setEmail] = useState(emailFromLink)

    // 定义密码状态，并提供更新函数
    const [password, setPassword] = useState('')

    // 定义加载状态，并提供更新函数
    const [isLoading, setIsLoading] = useState(false);

    // 定义处理电子邮件和密码登录函数
    const handleEmailPasswordLogin = async() => {
        // 如果电子邮件为空，显示错误并返回
        if (!email) {
            Toast.notify({
                type: 'error',
                message: t('login.error.emailEmpty')
            });
            return;
        }
        // 如果电子邮件格式不正确，显示错误提示并返回
        if (!emailRegex.test(email)) {
            Toast.notify({
                type: 'error',
                message: t('login.error.emailInValid'),
            });
            return;
        }

        // 如果密码为空，显示错误提示并返回
        if (!password?.trim()) {
            Toast.notify({
                type: 'error',
                message: t('login.error.passwordEmpty')
            });
            return;
        }

        try {
            // 设置加载状态为 true
            setIsLoading(true);
            // 构造登录数据，包括电子邮件，密码，语言和是否记住登录状态
            const loginData: Record<string, any> = {
                email, password, language: locale, remeber_me: true,
            };
            // 如果是邀请登录，添加邀请令牌
            if (isInvite)
                loginData.invite_token = decodeURIComponent(searchParams.get('invite_token') as string);
            // 调用登录函数，发送登录请求
            const res = await login({
                url: '/login',
                body: loginData,
            });
            // 如果登录成功
            if(res.result === 'sucess') {
                // 如果是邀请登录，跳转到邀请设置页面
                if (isInvite) {
                    router.replace(`/signin/invite-settings?${searchParams.toString()}`);
                }
                // 如果不是邀请登录，保存令牌并跳转到应用页面
                else {
                    // localStorage 是一个 webapi 用于在浏览器中存储数据
                    // 在这里，我们通过这个 api 保存令牌
                    localStorage.setItem('console_token', res.data.access_token); // 保存访问令牌
                    localStorage.setItem('refresh_token', res.data.refresh_token); // 保存刷新
                    router.replace('/apps');
                }
            }

            // 如果账户没有被找到
            else if (res.code === 'account_not_found') {
                // 如果允许注册，包含电子邮件和令牌
                const params = new URLSearchParams();
                params.append('email', encodeURIComponent(email));
                params.append('token', encodeURIComponent(res.data));

                // 跳转到重置密码页面
                router.replace(`/reset-password/check-code?${params.toString()}`)
            }

            // 如果不允许注册，显示错误信息
            else {
                Toast.notify({
                    type: 'error',
                    message: t('login.error.registrationNotAllowed'),
                });
            }
        }
        // 其他错误情况，显示错误提示
        else {
            Toast.notify({
                type: 'error',
                message: res.data,
            });
        }
        finally {
            setIsLoading(false);
        }
    };

    return 

    <form onSubmit={() => { }}>
        <div className="mb-3">
            <label htmlFor="email" className="my-2 system-md-semibold text-text-secondary">
                {t('login.email')}
            </label>
            <div className="mt-1">
                <Input
                    value={email}
                    onChange={e => setEmail(e.target.value)}
                    disabled={isInvite} // 如果是邀请登录，禁用输入框
                    id="email"
                    type="email"
                    autoComplete="email"
                    placeholder={t('login.emailPlaceholder') || ''} // 显示电子邮件占位符
                    tabIndex={1}
                />
            </div>
        </div>

        <div className='mb-3'>
          <label htmlFor="password" className="my-2 flex items-center justify-between">
            <span className='system-md-semibold text-text-secondary'>{t('login.password')}</span> // 显示密码标签
            <Link
              href={`/reset-password?${searchParams.toString()}`} // 链接到重置密码页面
              className={`system-xs-regular ${isEmailSetup ? 'text-components-button-secondary-accent-text' : 'text-components-button-secondary-accent-text-disabled pointer-events-none'}`}
              tabIndex={isEmailSetup ? 0 : -1}
              aria-disabled={!isEmailSetup}
            >
              {t('login.forget')}
            </Link>
          </label>
          <div className="relative mt-1">
            <Input
              id="password"
              value={password} // 绑定密码值
              onChange={e => setPassword(e.target.value)} // 更新密码值
              onKeyDown={(e) => {
                if (e.key === 'Enter') // 如果按下回车键，调用登录函数
                  handleEmailPasswordLogin()
              }}
              type={showPassword ? 'text' : 'password'} // 根据状态显示密码或隐藏密码
              autoComplete="current-password"
              placeholder={t('login.passwordPlaceholder') || ''} // 显示密码占位符
              tabIndex={2}
            />
            <div className="absolute inset-y-0 right-0 flex items-center">
              <Button
                type="button"
                variant='ghost'
                onClick={() => setShowPassword(!showPassword)} // 切换显示密码状态
              >
                {showPassword ? '👀' : '😝'} // 显示图标，表示显示或隐藏密码
              </Button>
            </div>
          </div>
        </div>

        <div className='mb-2'>
          <Button
            tabIndex={2}
            variant='primary'
            onClick={handleEmailPasswordLogin} // 点击按钮时调用登录函数
            disabled={isLoading || !email || !password} // 如果正在加载或输入为空，禁用按钮
            className="w-full"
          >{t('login.signBtn')}</Button> 
        </div>
    </form>
}
```

