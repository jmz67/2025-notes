
当我们渲染进入 signin 页面的时候，我们会先从去 URL 中将参数提取出来，然后使用 decodeURIComponent 将参数中附带的这些 token 提取出来。

```jsx
const searchParams = useSearchParams();
```

```jsx
import React, { useCallback, useEffect, useState } from 'react'  // 引入 React 和相关 hooks
import { useTranslation } from 'react-i18next'  // 用于多语言翻译
import Link from 'next/link'  // 用于 Next.js 的链接组件
import { useRouter, useSearchParams } from 'next/navigation'  // Next.js 路由相关功能
import { RiContractLine, RiDoorLockLine, RiErrorWarningFill } from '@remixicon/react'  // 引入图标组件
import Loading from '../components/base/loading'  // 引入 Loading 组件
import MailAndCodeAuth from './components/mail-and-code-auth'  // 引入邮箱验证码登录组件
import MailAndPasswordAuth from './components/mail-and-password-auth'  // 引入邮箱密码登录组件
import SocialAuth from './components/social-auth'  // 引入社交账号登录组件
import SSOAuth from './components/sso-auth'  // 引入单点登录（SSO）组件
import cn from '@/utils/classnames'  // 引入动态类名工具
import { getSystemFeatures, invitationCheck } from '@/service/common'  // 引入获取系统功能和邀请验证的服务
import { LicenseStatus, defaultSystemFeatures } from '@/types/feature'  // 引入许可证状态和默认系统功能
import Toast from '@/app/components/base/toast'  // 引入 Toast 消息组件
import { IS_CE_EDITION } from '@/config'  // 引入是否为企业版的配置

const NormalForm = () => {  // 登录表单组件

  const { t } = useTranslation()  // 获取翻译功能
  const router = useRouter()  // 获取路由实例
  const searchParams = useSearchParams()  // 获取 URL 中的查询参数

  // 从 URL 查询参数中获取相关值，并进行解码
  const consoleToken = decodeURIComponent(searchParams.get('access_token') || '')
  const refreshToken = decodeURIComponent(searchParams.get('refresh_token') || '')
  const message = decodeURIComponent(searchParams.get('message') || '')
  const invite_token = decodeURIComponent(searchParams.get('invite_token') || '')

  // 定义一些 UI 状态
  const [isLoading, setIsLoading] = useState(true)  // 控制加载状态
  const [systemFeatures, setSystemFeatures] = useState(defaultSystemFeatures)  // 存储系统功能配置
  const [authType, updateAuthType] = useState<'code' | 'password'>('password')  // 控制当前的认证方式
  const [showORLine, setShowORLine] = useState(false)  // 控制是否显示 OR 分隔线
  const [allMethodsAreDisabled, setAllMethodsAreDisabled] = useState(false)  // 控制是否禁用所有认证方法
  const [workspaceName, setWorkSpaceName] = useState('')  // 存储工作区名称

  // 判断是否为邀请链接
  const isInviteLink = Boolean(invite_token && invite_token !== 'null')

  // 初始化函数
  const init = useCallback(async () => {  // 使用 useCallback 确保函数不在每次渲染时都重新定义
    try {
      // 如果 URL 中包含 access_token 和 refresh_token，则直接存储并跳转
      if (consoleToken && refreshToken) {
        localStorage.setItem('console_token', consoleToken)  // 保存 console_token 到 localStorage
        localStorage.setItem('refresh_token', refreshToken)  // 保存 refresh_token 到 localStorage
        router.replace('/apps')  // 重定向到 /apps 页面
        return
      }

      // 如果 URL 中包含 message，显示错误提示
      if (message) {
        Toast.notify({
          type: 'error',
          message,
        })
      }

      // 获取系统功能配置
      const features = await getSystemFeatures()
      const allFeatures = { ...defaultSystemFeatures, ...features }  // 合并默认功能和获取到的功能
      setSystemFeatures(allFeatures)  // 更新系统功能状态
      // 判断是否禁用所有认证方法
      setAllMethodsAreDisabled(!allFeatures.enable_social_oauth_login && !allFeatures.enable_email_code_login && !allFeatures.enable_email_password_login && !allFeatures.sso_enforced_for_signin)
      // 判断是否显示 OR 分隔线
      setShowORLine((allFeatures.enable_social_oauth_login || allFeatures.sso_enforced_for_signin) && (allFeatures.enable_email_code_login || allFeatures.enable_email_password_login))
      // 根据是否允许邮箱密码登录来设置默认认证方式
      updateAuthType(allFeatures.enable_email_password_login ? 'password' : 'code')

      // 如果是邀请链接，验证邀请
      if (isInviteLink) {
        const checkRes = await invitationCheck({
          url: '/activate/check',
          params: {
            token: invite_token,
          },
        })
        setWorkSpaceName(checkRes?.data?.workspace_name || '')  // 获取并设置工作区名称
      }
    }
    catch (error) {
      console.error(error)  // 打印错误日志
      setAllMethodsAreDisabled(true)  // 如果发生错误，禁用所有认证方法
      setSystemFeatures(defaultSystemFeatures)  // 重置系统功能为默认值
    }
    finally { 
      setIsLoading(false)  // 无论成功还是失败，加载完成
    }
  }, [consoleToken, refreshToken, message, router, invite_token, isInviteLink])  // 依赖项：consoleToken、refreshToken 等

  useEffect(() => {  // 组件加载时调用初始化函数
    init()
  }, [init])  // 依赖项：init

  // 如果正在加载或者已经有有效的 consoleToken，显示 loading 状态
  if (isLoading || consoleToken) {
    return <div className={cn('flex flex-col items-center w-full grow justify-center', 'px-6', 'md:px-[108px]')}>
      <Loading type='area' />  {/* 加载动画 */}
    </div>
  }

  // 如果许可证状态为 LOST，显示相应提示
  if (systemFeatures.license?.status === LicenseStatus.LOST) {
    return <div className='w-full mx-auto mt-8'>
      <div className='bg-white'>
        <div className="p-4 rounded-lg bg-gradient-to-r from-workflow-workflow-progress-bg-1 to-workflow-workflow-progress-bg-2">
          <div className='flex items-center justify-center w-10 h-10 rounded-xl bg-components-card-bg shadow shadows-shadow-lg mb-2 relative'>
            <RiContractLine className='w-5 h-5' />  {/* 图标 */}
            <RiErrorWarningFill className='absolute w-4 h-4 text-text-warning-secondary -top-1 -right-1' />  {/* 错误提示图标 */}
          </div>
          <p className='system-sm-medium text-text-primary'>{t('login.licenseLost')}</p>
          <p className='system-xs-regular text-text-tertiary mt-1'>{t('login.licenseLostTip')}</p>
        </div>
      </div>
    </div>
  }

  // 如果许可证状态为 EXPIRED，显示相应提示
  if (systemFeatures.license?.status === LicenseStatus.EXPIRED) {
    return <div className='w-full mx-auto mt-8'>
      <div className='bg-white'>
        <div className="p-4 rounded-lg bg-gradient-to-r from-workflow-workflow-progress-bg-1 to-workflow-workflow-progress-bg-2">
          <div className='flex items-center justify-center w-10 h-10 rounded-xl bg-components-card-bg shadow shadows-shadow-lg mb-2 relative'>
            <RiContractLine className='w-5 h-5' />  {/* 图标 */}
            <RiErrorWarningFill className='absolute w-4 h-4 text-text-warning-secondary -top-1 -right-1' />  {/* 错误提示图标 */}
          </div>
          <p className='system-sm-medium text-text-primary'>{t('login.licenseExpired')}</p>
          <p className='system-xs-regular text-text-tertiary mt-1'>{t('login.licenseExpiredTip')}</p>
        </div>
      </div>
    </div>
  }

  // 如果许可证状态为 INACTIVE，显示相应提示
  if (systemFeatures.license?.status === LicenseStatus.INACTIVE) {
    return <div className='w-full mx-auto mt-8'>
      <div className='bg-white'>
        <div className="p-4 rounded-lg bg-gradient-to-r from-workflow-workflow-progress-bg-1 to-workflow-workflow-progress-bg-2">
          <div className='flex items-center justify-center w-10 h-10 rounded-xl bg-components-card-bg shadow shadows-shadow-lg mb-2 relative'>
            <RiContractLine className='w-5 h-5' />  {/* 图标 */}
            <RiErrorWarningFill className='absolute w-4 h-4 text-text-warning-secondary -top-1 -right-1' />  {/* 错误提示图标 */}
          </div>
          <p className='system-sm-medium text-text-primary'>{t('login.licenseInactive')}</p>
          <p className='system-xs-regular text-text-tertiary mt-1'>{t('login.licenseInactiveTip')}</p>
        </div>
      </div>
    </div>
  }

  return (  // 渲染登录表单
    <>
      <div className="w-full mx-auto mt-8">
        {isInviteLink  // 如果是邀请链接，显示工作区相关信息
          ? <div className="w-full mx-auto">
            <h2 className="title-4xl-semi-bold text-text-primary">{t('login.join')}{workspaceName}</h2>
            <p className='mt-2 body-md-regular text-text-tertiary'>{t('login.joinTipStart')}{workspaceName}{t('login.joinTipEnd')}</p>
          </div>
          : <div className="w-full mx-auto">
            <h2 className="title-4xl-semi-bold text-text-primary">{t('login.pageTitle')}</h2>
            <p className='mt-2 body-md-regular text-text-tertiary'>{t('login.welcome')}</p>
          </div>}
        <div className="bg-white">
          <div className="flex flex-col gap-3 mt-6">
            {systemFeatures.enable_social_oauth_login && <SocialAuth />}  {/* 显示社交登录组件 */}
            {systemFeatures.sso_enforced_for_signin && <div className='w-full'>
              <SSOAuth protocol={systemFeatures.sso_enforced_for_signin_protocol} />  {/* 显示 SSO 登录组件 */}
            </div>}
          </div>

          {showORLine && <div className="relative mt-6">
            <div className="absolute inset-0 flex items-center" aria-hidden="true">
              <div className='bg-gradient-to-r from-background-gradient-mask-transparent via-divider-regular to-background-gradient-mask-transparent h-px w-full'></div>
            </div>
            <div className="relative flex justify-center">
              <span className="px-2 text-text-tertiary system-xs-medium-uppercase bg-white">{t('login.or')}</span>
            </div>
          </div>}
          {
            (systemFeatures.enable_email_code_login || systemFeatures.enable_email_password_login) && <>
              {systemFeatures.enable_email_code_login && authType === 'code' && <>
                <MailAndCodeAuth isInvite={isInviteLink} />  {/* 显示邮箱验证码登录组件 */}
                {systemFeatures.enable_email_password_login && <div className='cursor-pointer py-1 text-center' onClick={() => { updateAuthType('password') }}>
                  <span className='system-xs-medium text-components-button-secondary-accent-text'>{t('login.usePassword')}</span>
                </div>}
              </>}
              {systemFeatures.enable_email_password_login && authType === 'password' && <>
                <MailAndPasswordAuth isInvite={isInviteLink} isEmailSetup={systemFeatures.is_email_setup} allowRegistration={systemFeatures.is_allow_register} />  {/* 显示邮箱密码登录组件 */}
                {systemFeatures.enable_email_code_login && <div className='cursor-pointer py-1 text-center' onClick={() => { updateAuthType('code') }}>
                  <span className='system-xs-medium text-components-button-secondary-accent-text'>{t('login.useVerificationCode')}</span>
                </div>}
              </>}
            </>
          }
          
          {/* 如果没有可用的登录方法，则显示提示 */}
        </div>
      </div>
    </>
  )
}

export default NormalForm  // 导出登录表单组件
```


```jsx
import Link from 'next/link' // 导入 Next.js 的 Link 组件，用于客户端路由跳转
import { useState } from 'react' // 导入 React 的 useState Hook，用于管理组件状态
import { useTranslation } from 'react-i18next' // 导入 react-i18next 的 useTranslation Hook，用于处理国际化
import { useRouter, useSearchParams } from 'next/navigation' // 导入 Next.js 的 useRouter 和 useSearchParams Hook，用于路由导航和获取查询参数
import { useContext } from 'use-context-selector' // 导入 use-context-selector 的 useContext Hook，用于访问 Context
import Button from '@/app/components/base/button' // 导入自定义的 Button 组件
import Toast from '@/app/components/base/toast' // 导入自定义的 Toast 组件，用于显示消息提示
import { emailRegex } from '@/config' // 导入邮箱正则表达式
import { login } from '@/service/common' // 导入登录服务函数
import Input from '@/app/components/base/input' // 导入自定义的 Input 组件
import I18NContext from '@/context/i18n' // 导入国际化 Context

// 定义 MailAndPasswordAuth 组件的 Props 类型
type MailAndPasswordAuthProps = {
  isInvite: boolean // 是否是邀请注册
  isEmailSetup: boolean // 是否已设置邮箱
  allowRegistration: boolean // 是否允许注册
}

const passwordRegex = /^(?=.*[a-zA-Z])(?=.*\d).{8,}$/ // 定义密码正则表达式，至少8位，包含字母和数字

// 导出 MailAndPasswordAuth 组件
export default function MailAndPasswordAuth({ isInvite, isEmailSetup, allowRegistration }: MailAndPasswordAuthProps) {
  const { t } = useTranslation() // 获取国际化函数 t
  const { locale } = useContext(I18NContext) // 从 Context 中获取当前语言环境
  const router = useRouter() // 获取 Next.js 路由对象
  const searchParams = useSearchParams() // 获取 Next.js 查询参数对象
  const [showPassword, setShowPassword] = useState(false) // 初始化 showPassword 状态，用于控制密码显示/隐藏
  const emailFromLink = decodeURIComponent(searchParams.get('email') || '') // 从链接中获取 email 参数，并进行解码
  const [email, setEmail] = useState(emailFromLink) // 初始化 email 状态，默认值为链接中的 email
  const [password, setPassword] = useState('') // 初始化 password 状态

  const [isLoading, setIsLoading] = useState(false) // 初始化 isLoading 状态，用于控制按钮加载状态
  const handleEmailPasswordLogin = async () => {
    if (!email) { // 如果 email 为空
      Toast.notify({ type: 'error', message: t('login.error.emailEmpty') }) // 显示 email 为空的错误提示
      return // 阻止继续执行
    }
    if (!emailRegex.test(email)) { // 如果 email 格式不正确
      Toast.notify({
        type: 'error',
        message: t('login.error.emailInValid'), // 显示 email 格式无效的错误提示
      })
      return // 阻止继续执行
    }
    if (!password?.trim()) { // 如果 password 为空或仅包含空格
      Toast.notify({ type: 'error', message: t('login.error.passwordEmpty') }) // 显示 password 为空的错误提示
      return // 阻止继续执行
    }
    if (!passwordRegex.test(password)) { // 如果 password 格式不正确
      Toast.notify({
        type: 'error',
        message: t('login.error.passwordInvalid'), // 显示 password 格式无效的错误提示
      })
      return // 阻止继续执行
    }
    try {
      setIsLoading(true) // 设置 isLoading 状态为 true，显示加载动画
      const loginData: Record<string, any> = { // 创建登录数据对象
        email,
        password,
        language: locale,
        remember_me: true,
      }
      if (isInvite) // 如果是邀请注册
        loginData.invite_token = decodeURIComponent(searchParams.get('invite_token') as string) // 添加 invite_token 参数
      const res = await login({ // 调用登录服务函数
        url: '/login',
        body: loginData,
      })
      if (res.result === 'success') { // 如果登录成功
        if (isInvite) { // 如果是邀请注册
          router.replace(`/signin/invite-settings?${searchParams.toString()}`) // 跳转到邀请设置页面
        }
        else { // 否则
          localStorage.setItem('console_token', res.data.access_token) // 存储 access_token 到 localStorage
          localStorage.setItem('refresh_token', res.data.refresh_token) // 存储 refresh_token 到 localStorage
          router.replace('/apps') // 跳转到应用列表页面
        }
      }
      else if (res.code === 'account_not_found') { // 如果账号不存在
        if (allowRegistration) { // 如果允许注册
          const params = new URLSearchParams() // 创建新的查询参数对象
          params.append('email', encodeURIComponent(email)) // 添加 email 参数
          params.append('token', encodeURIComponent(res.data)) // 添加 token 参数
          router.replace(`/reset-password/check-code?${params.toString()}`) // 跳转到重置密码验证码页面
        }
        else { // 如果不允许注册
          Toast.notify({
            type: 'error',
            message: t('login.error.registrationNotAllowed'), // 显示注册不被允许的错误提示
          })
        }
      }
      else { // 其他错误
        Toast.notify({
          type: 'error',
          message: res.data, // 显示错误信息
        })
      }
    }

    finally {
      setIsLoading(false) // 设置 isLoading 状态为 false，隐藏加载动画
    }
  }

  return <form onSubmit={() => { }}> {/* 表单，onSubmit 事件为空函数，防止默认提交行为 */}
    <div className='mb-3'> {/* 包含 email label 和 input 的 div */}
      <label htmlFor="email" className="my-2 system-md-semibold text-text-secondary">
        {t('login.email')} {/* email label */}
      </label>
      <div className="mt-1"> {/* 包含 email input 的 div */}
        <Input
          value={email}
          onChange={e => setEmail(e.target.value)}
          disabled={isInvite}
          id="email"
          type="email"
          autoComplete="email"
          placeholder={t('login.emailPlaceholder') || ''}
          tabIndex={1}
        />
      </div>
    </div>

    <div className='mb-3'> {/* 包含 password label 和 input 的 div */}
      <label htmlFor="password" className="my-2 flex items-center justify-between">
        <span className='system-md-semibold text-text-secondary'>{t('login.password')}</span> {/* password label */}
        <Link
          href={`/reset-password?${searchParams.toString()}`}
          className={`system-xs-regular ${isEmailSetup ? 'text-components-button-secondary-accent-text' : 'text-components-button-secondary-accent-text-disabled pointer-events-none'}`}
          tabIndex={isEmailSetup ? 0 : -1}
          aria-disabled={!isEmailSetup}
        >
          {t('login.forget')} {/* 忘记密码链接 */}
        </Link>
      </label>
      <div className="relative mt-1"> {/* 包含 password input 和显示/隐藏密码按钮的 div */}
        <Input
          id="password"
          value={password}
          onChange={e => setPassword(e.target.value)}
          onKeyDown={(e) => {
            if (e.key === 'Enter')
              handleEmailPasswordLogin()
          }}
          type={showPassword ? 'text' : 'password'}
          autoComplete="current-password"
          placeholder={t('login.passwordPlaceholder') || ''}
          tabIndex={2}
        />
        <div className="absolute inset-y-0 right-0 flex items-center"> {/* 显示/隐藏密码按钮的 div */}
          <Button
            type="button"
            variant='ghost'
            onClick={() => setShowPassword(!showPassword)}
          >
            {showPassword ? '👀' : '😝'} {/* 显示/隐藏密码按钮的图标 */}
          </Button>
        </div>
      </div>
    </div>

    <div className='mb-2'> {/* 包含登录按钮的 div */}
      <Button
        tabIndex={2}
        variant='primary'
        onClick={handleEmailPasswordLogin}
        disabled={isLoading || !email || !password}
        className="w-full"
      >{t('login.signBtn')}</Button> {/* 登录按钮 */}
    </div>
  </form>
}
```

